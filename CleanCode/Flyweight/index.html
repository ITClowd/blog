<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="tags: #cleancode/designpatterns
Flyweight Intent Flyweight is a structural design pattern that lets you fit more objects into the available amount of RAM by sharing common parts of state between multiple objects instead of keeping all of the data in each object."><meta property="og:title" content="Flyweight"><meta property="og:description" content="tags: #cleancode/designpatterns
Flyweight Intent Flyweight is a structural design pattern that lets you fit more objects into the available amount of RAM by sharing common parts of state between multiple objects instead of keeping all of the data in each object."><meta property="og:type" content="website"><meta property="og:image" content="https://knowledge.vogel.businessicon.png"><meta property="og:url" content="https://knowledge.vogel.business/CleanCode/Flyweight/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Flyweight"><meta name=twitter:description content="tags: #cleancode/designpatterns
Flyweight Intent Flyweight is a structural design pattern that lets you fit more objects into the available amount of RAM by sharing common parts of state between multiple objects instead of keeping all of the data in each object."><meta name=twitter:image content="https://knowledge.vogel.businessicon.png"><title>Flyweight</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://knowledge.vogel.business/icon.png><link href=https://knowledge.vogel.business/styles.b369a84b3c6e6bfd686ad1f9da65641c.min.css rel=stylesheet><link href=https://knowledge.vogel.business/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://knowledge.vogel.business/js/darkmode.49e02f55b6384a9e088ce2395a1ab3fb.min.js></script>
<script src=https://knowledge.vogel.business/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script async src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script async src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script async src=https://knowledge.vogel.business/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://knowledge.vogel.business/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://knowledge.vogel.business/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://knowledge.vogel.business/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://knowledge.vogel.business",fetchData=Promise.all([fetch("https://knowledge.vogel.business/indices/linkIndex.05877276bafea51c34835ef637a0896f.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://knowledge.vogel.business/indices/contentIndex.033a8de1cbae8bcc739bc6f4ccdb68d0.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://knowledge.vogel.business",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://knowledge.vogel.business",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/knowledge.vogel.business\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=knowledge.vogel.business src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://knowledge.vogel.business/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://knowledge.vogel.business>Momolem's Digital Garden</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Flyweight</h1><p class=meta>Last updated
Unknown</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#intent>Intent</a></li><li><a href=#problem>Problem</a></li><li><a href=#solution> Solution</a><ol><li><a href=#extrinsic-state-storage>Extrinsic state storage</a></li><li><a href=#flyweight-and-immutability>Flyweight and immutability</a></li><li><a href=#flyweight-factory>Flyweight factory</a></li></ol></li><li><a href=#structure>Structure</a></li><li><a href=#pseudocode> Pseudocode</a></li><li><a href=#applicability>Applicability</a></li><li><a href=#how-to-implement>How to Implement</a></li><li><a href=#pro-and--cons>Pro and Cons</a></li><li><a href=#relations-with-other-patterns>Relations with Other Patterns</a></li></ol></nav></details></aside><p>tags: #cleancode/designpatterns</p><a href=#flyweight><h1 id=flyweight><span class=hanchor arialabel=Anchor># </span>Flyweight</h1></a><a href=#intent><h2 id=intent><span class=hanchor arialabel=Anchor># </span>Intent</h2></a><p><strong>Flyweight</strong> is a structural design pattern that lets you fit more objects into the available amount of RAM by sharing common parts of state between multiple objects instead of keeping all of the data in each object.</p><a href=#problem><h2 id=problem><span class=hanchor arialabel=Anchor># </span>Problem</h2></a><p>To have some fun after long working hours, you decided to create a simple video game: players would be moving around a map and shooting each other. You chose to implement a realistic particle system and make it a distinctive feature of the game. Vast quantities of bullets, missiles, and shrapnel from explosions should fly all over the map and deliver a thrilling experience to the player.</p><p>Upon its completion, you pushed the last commit, built the game and sent it to your friend for a test drive. Although the game was running flawlessly on your machine, your friend wasn’t able to play for long. On his computer, the game kept crashing after a few minutes of gameplay. After spending several hours digging through debug logs, you discovered that the game crashed because of an insufficient amount of RAM. It turned out that your friend’s rig was much less powerful than your own computer, and that’s why the problem emerged so quickly on his machine.</p><p>The actual problem was related to your particle system. Each particle, such as a bullet, a missile or a piece of shrapnel was represented by a separate object containing plenty of data. At some point, when the carnage on a player’s screen reached its climax, newly created particles no longer fit into the remaining RAM, so the program crashed.</p><p><img src=https://refactoring.guru/images/patterns/diagrams/flyweight/problem-en.png width=auto alt="Flyweight pattern problem"></p><a href=#solution><h2 id=solution><span class=hanchor arialabel=Anchor># </span> Solution</h2></a><p>On closer inspection of the <code>Particle</code> class, you may notice that the color and sprite fields consume a lot more memory than other fields. What’s worse is that these two fields store almost identical data across all particles. For example, all bullets have the same color and sprite.</p><p><img src=https://refactoring.guru/images/patterns/diagrams/flyweight/solution1-en.png width=auto alt="Flyweight pattern solution"></p><p>Other parts of a particle’s state, such as coordinates, movement vector and speed, are unique to each particle. After all, the values of these fields change over time. This data represents the always changing context in which the particle exists, while the color and sprite remain constant for each particle.</p><p>This constant data of an object is usually called the <em>intrinsic state</em>. It lives within the object; other objects can only read it, not change it. The rest of the object’s state, often altered “from the outside” by other objects, is called the <em>extrinsic state</em>.</p><p>The Flyweight pattern suggests that you stop storing the extrinsic state inside the object. Instead, you should pass this state to specific methods which rely on it. Only the intrinsic state stays within the object, letting you reuse it in different contexts. As a result, you’d need fewer of these objects since they only differ in the intrinsic state, which has much fewer variations than the extrinsic.</p><p><img src=https://refactoring.guru/images/patterns/diagrams/flyweight/solution3-en.png width=auto alt="Flyweight pattern solution"></p><p>Let’s return to our game. Assuming that we had extracted the extrinsic state from our particle class, only three different objects would suffice to represent all particles in the game: a bullet, a missile, and a piece of shrapnel. As you’ve probably guessed by now, an object that only stores the intrinsic state is called a flyweight.</p><a href=#extrinsic-state-storage><h3 id=extrinsic-state-storage><span class=hanchor arialabel=Anchor># </span>Extrinsic state storage</h3></a><p>Where does the extrinsic state move to? Some class should still store it, right? In most cases, it gets moved to the container object, which aggregates objects before we apply the pattern.</p><p>In our case, that’s the main <code>Game</code> object that stores all particles in the <code>particles</code> field. To move the extrinsic state into this class, you need to create several array fields for storing coordinates, vectors, and speed of each individual particle. But that’s not all. You need another array for storing references to a specific flyweight that represents a particle. These arrays must be in sync so that you can access all data of a particle using the same index.</p><p><img src=https://refactoring.guru/images/patterns/diagrams/flyweight/solution2-en.png width=auto alt="Flyweight pattern solution"></p><p>A more elegant solution is to create a separate context class that would store the extrinsic state along with reference to the flyweight object. This approach would require having just a single array in the container class.</p><p>Wait a second! Won’t we need to have as many of these contextual objects as we had at the very beginning? Technically, yes. But the thing is, these objects are much smaller than before. The most memory-consuming fields have been moved to just a few flyweight objects. Now, a thousand small contextual objects can reuse a single heavy flyweight object instead of storing a thousand copies of its data.</p><a href=#flyweight-and-immutability><h3 id=flyweight-and-immutability><span class=hanchor arialabel=Anchor># </span>Flyweight and immutability</h3></a><p>Since the same flyweight object can be used in different contexts, you have to make sure that its state can’t be modified. A flyweight should initialize its state just once, via constructor parameters. It shouldn’t expose any setters or public fields to other objects.</p><a href=#flyweight-factory><h3 id=flyweight-factory><span class=hanchor arialabel=Anchor># </span>Flyweight factory</h3></a><p>For more convenient access to various flyweights, you can create a factory method that manages a pool of existing flyweight objects. The method accepts the intrinsic state of the desired flyweight from a client, looks for an existing flyweight object matching this state, and returns it if it was found. If not, it creates a new flyweight and adds it to the pool.</p><p>There are several options where this method could be placed. The most obvious place is a flyweight container. Alternatively, you could create a new factory class. Or you could make the factory method static and put it inside an actual flyweight class.</p><a href=#structure><h2 id=structure><span class=hanchor arialabel=Anchor># </span>Structure</h2></a><p><img src=https://refactoring.guru/images/patterns/diagrams/flyweight/structure.png width=auto alt="Structure of the Flyweight design pattern"></p><ol><li>The Flyweight pattern is merely an optimization. Before applying it, make sure your program does have the RAM consumption problem related to having a massive number of similar objects in memory at the same time. Make sure that this problem can’t be solved in any other meaningful way.</li><li>The <strong>Flyweight</strong> class contains the portion of the original object’s state that can be shared between multiple objects. The same flyweight object can be used in many different contexts. The state stored inside a flyweight is called <em>intrinsic.</em> The state passed to the flyweight’s methods is called <em>extrinsic.</em></li><li>The <strong>Context</strong> class contains the extrinsic state, unique across all original objects. When a context is paired with one of the flyweight objects, it represents the full state of the original object.</li><li>Usually, the behavior of the original object remains in the flyweight class. In this case, whoever calls a flyweight’s method must also pass appropriate bits of the extrinsic state into the method’s parameters. On the other hand, the behavior can be moved to the context class, which would use the linked flyweight merely as a data object.</li><li>The <strong>Client</strong> calculates or stores the extrinsic state of flyweights. From the client’s perspective, a flyweight is a template object which can be configured at runtime by passing some contextual data into parameters of its methods.</li><li>The <strong>Flyweight Factory</strong> manages a pool of existing flyweights. With the factory, clients don’t create flyweights directly. Instead, they call the factory, passing it bits of the intrinsic state of the desired flyweight. The factory looks over previously created flyweights and either returns an existing one that matches search criteria or creates a new one if nothing is found.</li></ol><a href=#pseudocode><h2 id=pseudocode><span class=hanchor arialabel=Anchor># </span> Pseudocode</h2></a><p>In this example, the <strong>Flyweight</strong> pattern helps to reduce memory usage when rendering millions of tree objects on a canvas.</p><p><img src=https://refactoring.guru/images/patterns/diagrams/flyweight/example.png width=auto alt="Flyweight pattern example"></p><p>The pattern extracts the repeating intrinsic state from a main <code>Tree</code> class and moves it into the flyweight class <code>TreeType</code>.</p><p>Now instead of storing the same data in multiple objects, it’s kept in just a few flyweight objects and linked to appropriate <code>Tree</code> objects which act as contexts. The client code creates new tree objects using the flyweight factory, which encapsulates the complexity of searching for the right object and reusing it if needed.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=c1>// The flyweight class contains a portion of the state of a
</span></span></span><span class=line><span class=cl><span class=c1>// tree. These fields store values that are unique for each
</span></span></span><span class=line><span class=cl><span class=c1>// particular tree. For instance, you won&#39;t find here the tree
</span></span></span><span class=line><span class=cl><span class=c1>// coordinates. But the texture and colors shared between many
</span></span></span><span class=line><span class=cl><span class=c1>// trees are here. Since this data is usually BIG, you&#39;d waste a
</span></span></span><span class=line><span class=cl><span class=c1>// lot of memory by keeping it in each tree object. Instead, we
</span></span></span><span class=line><span class=cl><span class=c1>// can extract texture, color and other repeating data into a
</span></span></span><span class=line><span class=cl><span class=c1>// separate object which lots of individual tree objects can
</span></span></span><span class=line><span class=cl><span class=c1>// reference.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>TreeType</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>    <span class=k>field</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>    <span class=k>field</span> <span class=n>color</span>
</span></span><span class=line><span class=cl>    <span class=k>field</span> <span class=n>texture</span>
</span></span><span class=line><span class=cl>    <span class=k>constructor</span> <span class=n>TreeType</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>color</span><span class=p>,</span> <span class=n>texture</span><span class=p>)</span> <span class=p>{</span> <span class=o>..</span><span class=p>.</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span> <span class=n>draw</span><span class=p>(</span><span class=n>canvas</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 1. Create a bitmap of a given type, color &amp; texture.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 2. Draw the bitmap on the canvas at X and Y coords.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Flyweight factory decides whether to re-use existing
</span></span></span><span class=line><span class=cl><span class=c1>// flyweight or to create a new object.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>TreeFactory</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>    <span class=n>static</span> <span class=k>field</span> <span class=n>treeTypes</span><span class=p>:</span> <span class=n>collection</span> <span class=n>of</span> <span class=n>tree</span> <span class=n>types</span>
</span></span><span class=line><span class=cl>    <span class=n>static</span> <span class=n>method</span> <span class=n>getTreeType</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>color</span><span class=p>,</span> <span class=n>texture</span><span class=p>)</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>        <span class=n>type</span> <span class=p>=</span> <span class=n>treeTypes</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>color</span><span class=p>,</span> <span class=n>texture</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>type</span> <span class=p>=</span> <span class=n>new</span> <span class=n>TreeType</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>color</span><span class=p>,</span> <span class=n>texture</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>treeTypes</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The contextual object contains the extrinsic part of the tree
</span></span></span><span class=line><span class=cl><span class=c1>// state. An application can create billions of these since they
</span></span></span><span class=line><span class=cl><span class=c1>// are pretty small: just two integer coordinates and one
</span></span></span><span class=line><span class=cl><span class=c1>// reference field.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Tree</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>    <span class=k>field</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span>
</span></span><span class=line><span class=cl>    <span class=k>field</span> <span class=n>type</span><span class=p>:</span> <span class=n>TreeType</span>
</span></span><span class=line><span class=cl>    <span class=k>constructor</span> <span class=n>Tree</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>type</span><span class=p>)</span> <span class=p>{</span> <span class=o>..</span><span class=p>.</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span> <span class=n>draw</span><span class=p>(</span><span class=n>canvas</span><span class=p>)</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>        <span class=n>type</span><span class=p>.</span><span class=n>draw</span><span class=p>(</span><span class=n>canvas</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The Tree and the Forest classes are the flyweight&#39;s clients.
</span></span></span><span class=line><span class=cl><span class=c1>// You can merge them if you don&#39;t plan to develop the Tree
</span></span></span><span class=line><span class=cl><span class=c1>// class any further.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Forest</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>    <span class=k>field</span> <span class=n>trees</span><span class=p>:</span> <span class=n>collection</span> <span class=n>of</span> <span class=n>Trees</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>method</span> <span class=n>plantTree</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>color</span><span class=p>,</span> <span class=n>texture</span><span class=p>)</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>        <span class=n>type</span> <span class=p>=</span> <span class=n>TreeFactory</span><span class=p>.</span><span class=n>getTreeType</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>color</span><span class=p>,</span> <span class=n>texture</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>tree</span> <span class=p>=</span> <span class=n>new</span> <span class=n>Tree</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>trees</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>tree</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>method</span> <span class=n>draw</span><span class=p>(</span><span class=n>canvas</span><span class=p>)</span> <span class=k>is</span>
</span></span><span class=line><span class=cl>        <span class=n>foreach</span> <span class=p>(</span><span class=n>tree</span> <span class=k>in</span> <span class=n>trees</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>            <span class=n>tree</span><span class=p>.</span><span class=n>draw</span><span class=p>(</span><span class=n>canvas</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><a href=#applicability><h2 id=applicability><span class=hanchor arialabel=Anchor># </span>Applicability</h2></a><ul><li>Use the Flyweight pattern only when your program must support a huge number of objects which barely fit into available RAM.
The benefit of applying the pattern depends heavily on how and where it’s used. It’s most useful when:<ul><li>an application needs to spawn a huge number of similar objects</li><li>this drains all available RAM on a target device</li><li>the objects contain duplicate states which can be extracted and shared between multiple objects</li></ul></li></ul><a href=#how-to-implement><h2 id=how-to-implement><span class=hanchor arialabel=Anchor># </span>How to Implement</h2></a><ol><li><p>Divide fields of a class that will become a flyweight into two parts:</p><ul><li>the intrinsic state: the fields that contain unchanging data duplicated across many objects</li><li>the extrinsic state: the fields that contain contextual data unique to each object</li></ul></li><li><p>Leave the fields that represent the intrinsic state in the class, but make sure they’re immutable. They should take their initial values only inside the constructor.</p></li><li><p>Go over methods that use fields of the extrinsic state. For each field used in the method, introduce a new parameter and use it instead of the field.</p></li><li><p>Optionally, create a factory class to manage the pool of flyweights. It should check for an existing flyweight before creating a new one. Once the factory is in place, clients must only request flyweights through it. They should describe the desired flyweight by passing its intrinsic state to the factory.</p></li><li><p>The client must store or calculate values of the extrinsic state (context) to be able to call methods of flyweight objects. For the sake of convenience, the extrinsic state along with the flyweight-referencing field may be moved to a separate context class.</p></li></ol><a href=#pro-and--cons><h2 id=pro-and--cons><span class=hanchor arialabel=Anchor># </span>Pro and Cons</h2></a><table><thead><tr><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td>You can save lots of RAM, assuming your program has tons of similar objects.</td><td>You might be trading RAM over CPU cycles when some of the context data needs to be recalculated each time somebody calls a flyweight method.</td></tr><tr><td></td><td>The code becomes much more complicated. New team members will always be wondering why the state of an entity was separated in such a way.</td></tr></tbody></table><a href=#relations-with-other-patterns><h2 id=relations-with-other-patterns><span class=hanchor arialabel=Anchor># </span>Relations with Other Patterns</h2></a><ul><li>You can implement shared leaf nodes of the <a href=/CleanCode/Composite rel=noopener class=internal-link data-src=/CleanCode/Composite>Composite</a> tree as Flyweights to save some RAM.</li><li>Flyweight shows how to make lots of little objects, whereas <a href=/CleanCode/Facade rel=noopener class=internal-link data-src=/CleanCode/Facade>Facade</a> shows how to make a single object that represents an entire subsystem.</li><li>Flyweight would resemble <a href=/CleanCode/Singleton rel=noopener class=internal-link data-src=/CleanCode/Singleton>Singleton</a> if you somehow managed to reduce all shared states of the objects to just one flyweight object. But there are two fundamental differences between these patterns:<ol><li>There should be only one <a href=/CleanCode/Singleton rel=noopener class=internal-link data-src=/CleanCode/Singleton>Singleton</a> instance, whereas a Flyweight class can have multiple instances with different intrinsic states.</li><li>The <a href=/CleanCode/Singleton rel=noopener class=internal-link data-src=/CleanCode/Singleton>Singleton</a> object can be mutable. Flyweight objects are immutable.</li></ol></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/CleanCode/Composite/ data-ctx=Flyweights data-src=/CleanCode/Composite class=internal-link>Composite</a></li><li><a href=/CleanCode/Design-Patterns/ data-ctx=CleanCode/Flyweight data-src=/CleanCode/Design-Patterns class=internal-link>Design Patterns</a></li><li><a href=/CleanCode/Facade/ data-ctx=CleanCode/Flyweight data-src=/CleanCode/Facade class=internal-link>Facade</a></li><li><a href=/CleanCode/Singleton/ data-ctx=CleanCode/Flyweight data-src=/CleanCode/Singleton class=internal-link>Singleton</a></li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://knowledge.vogel.business/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Moritz Vogel using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://knowledge.vogel.business>Home</a></li><li><a href=https://github.com/Momolem>GitHub</a></li><li><a href=https://gitlab.com/Momolem>Gitlab</a></li></ul></footer></div></div></body></html>